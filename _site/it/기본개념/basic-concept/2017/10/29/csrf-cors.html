<!DOCTYPE html>
<html lang="en">
<head>
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-100042262-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-100042262-1');
	</script>

	<title>뿡상의 개발공부로그</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- 파비콘 -->
	<link rel="shortcut icon" href="/images/favicon.ico">

	<!-- CSS -->
	<link rel="stylesheet" href="/css/common.css" />
	<link rel="stylesheet" href="/css/nav.css" />
	<link rel="stylesheet" href="/css/main.css" />
	<link rel="stylesheet" href="/css/post.css" />
	<link rel="stylesheet" href="/css/list.css" />
	<link rel="stylesheet" href="https://cdn.iconmonstr.com/1.2.0/css/iconmonstr-iconic-font.min.css">

	<!--external css-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href='https://cdn.iconmonstr.com/1.2.0/css/iconmonstr-iconic-font.min.css' rel='stylesheet'>

	<!-- font -->
	<link href='https://fonts.googleapis.com/css?family=Gloria Hallelujah' rel='stylesheet'>

	<link href='https://cdn.rawgit.com/openhiun/hangul/14c0f6faa2941116bb53001d6a7dcd5e82300c3f/nanumbarungothic.css' rel='stylesheet' type='text/css'>
	<link href='https://fonts.googleapis.com/css?family=Architects Daughter' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Bungee Hairline' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Bubbler One' rel='stylesheet'>
	<link href="https://fonts.googleapis.com/css?family=Patrick Hand SC" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
  <div id="container" class="container">
    <ul class="top_menu">
  <li class=" menu_list sidebar-toggle-box">
    <button class="menu_btn" id="menuBtn" title="메뉴토글버튼">
      <i class="im im-menu"></i>
    </button>
  </li>

  <li class="menu_list logo">
    <a href="/">
      bbungsang
      <i>devlog</i>
    </a>
  </li>
  <a href="https://www.facebook.com/profile.php?id=100003805377149"><li class="menu_ele">Facebook</li></a>
  <a href="https://github.com/bbungsang"><li class="menu_ele">GitHub</li></a>
</ul>

<!-- 사이드 메뉴바 -->
<div id="mySidenav" class="sidenav">
  <div class="intro-me">
    <div class="my-photo">
      <img src="/images/meme.png">
    </div>
    <div class="my-content">
      Please contact me if you have any questions
      <p>- Elena.Kim -</p>
      <button class="resume">미정</button>
    </div>
  </div>
  <ul class="menu-ele">
    <li>
      <a href="/files/python.html">
        <span class="bar-left"></span>
        파이썬
        <span class="bar-right"></span>
      </a>
    </li>
    <li>
      <a href="/files/django.html">
        <span class="bar-left"></span>
        장고
        <span class="bar-right"></span>
      </a>
    </li>
    <li>
      <a href="/files/algorithm.html">
        <span class="bar-left"></span>
        알고리즘
        <span class="bar-right"></span>
      </a>
    </li>
    <li>
      <a href="/files/server.html">
        <span class="bar-left"></span>
        서버
        <span class="bar-right"></span>
      </a>
    </li>
    <li>
      <a href="/files/study.html">
        <span class="bar-left"></span>
        스터디
        <span class="bar-right"></span>
      </a>
    </li>
  </ul>
</div>

<script>
  function sideNavBtnClickHandler(e) {
    document.getElementById("mySidenav").style.left = "0px";
    e.stopPropagation();
  }

  document.getElementById("menuBtn").addEventListener(
    "click",
    sideNavBtnClickHandler
  );

  window.addEventListener("click", function () {
    var sidenav = document.getElementsByClassName("sidenav");

    for(var i=0; i<sidenav.length; i++){
      var closeSidenav = sidenav[i];
      closeSidenav.style.left = "-240px";
    }
  });
</script>


    <section class="markdown">
  <article class="md-head">
    <div class="title">
      CORS와 CSRF(2)
    </div>
    <div class="tag-wrap">
      
      
        <a href="/tags/#CORS">
          <img src="/images/tag_img.png">
          CORS
        </a>
      
        <a href="/tags/#CSRF">
          <img src="/images/tag_img.png">
          CSRF
        </a>
      
        <a href="/tags/#HTTP">
          <img src="/images/tag_img.png">
          HTTP
        </a>
      
    </div>
  </article>
  <article class="markdown-body">
    <section class="post-content">
      <blockquote>
  <p><code class="highlighter-rouge">CORS</code>와 <code class="highlighter-rouge">CSRF</code>, 완전히 다른 개념임에도 불구하고 비슷한 이름으로 헷갈렸었다. 이 포스트에서 CSRF의 개념을 정리하고 장고에 적용하는 방법 및 예시를 작성하려 한다.</p>
</blockquote>

<h2 id="csrfcross-site-reuqest-forgery">CSRF(Cross Site Reuqest Forgery)</h2>
<p>사이트 간 요청 위조, 웹사이트의 취약점 공격의 하나로 CSRF 공격은 특정 웹 사이트가 사용자의 웹 브라우저를 신용하는 상태를 노린 것이다. 즉 사용자의 권한을 이용하여 서버에 부정적인 요청을 일으키는 공격이다.</p>

<p>사용자가 로그인한 상태에서 해당 공격 코드가 삽입된 페이지를 열면, 공격자가 의도한 요청이 열람한 유저 혹은 관리자의 권한으로 등록/수정/삭제 등이 이루어지게 된다.</p>

<h3 id="공격과정">공격과정</h3>
<p style="font-weight: bold; color: #8d8d8d; margin: 25px 0;">주 공격 대상</p>
<ul>
  <li>글쓰기 시 HTML 태그가 허용된 게시판</li>
</ul>

<p style="font-weight: bold; color: #8d8d8d; margin: 25px 0;">주 공격 대상</p>
<ul>
  <li>&lt;script&gt;, &lt;object&gt;, &lt;applet&gt;, &lt;embed&gt;, &lt;img&gt;, &lt;form&gt; 등</li>
</ul>

<p><img src="http://localhost:4000/assets/csrf.png" alt="" class="center-image" /></p>

<p style="font-weight: bold; color: #8d8d8d; margin: 25px 0;">피해 유형</p>
<ul>
  <li>정보 노출 쿠키 혹은 세션 정보 노출</li>
  <li>동일 작업 반복 게시물 클릭시 공격자가 원하는 동작 수행</li>
</ul>

<p style="font-weight: bold; color: #8d8d8d; margin: 25px 0;">보호 대책</p>
<ul>
  <li>가장 기본적으로 서버 상태를 변경하는 요청에 대해 GET을 쓰지 않는 것이다.</li>
  <li>하지만 POST 메소드의 경우에도 hidden 필드에 임의의 키값을 전달하고 그 키값이 맞는가를 매번 확인하도록 하는 절차가 필요하다.</li>
  <li>이때, 검증은 반드시 서버에서 이루어지도록 개발하여야 한다.</li>
</ul>

<h4 id="실제-공격-사례">실제 공격 사례</h4>

<p class="quote">
최근에 발생했던 옥션의 1800만명 개인 정보 유출 사고는 CSRF 공격을 당한 것으로 밝혀졌다. 중국 해커는 직접 서버를 공격하는 대신, 옥션 운영진을 대상으로 악성 코드를 첨부한 메일을 대량으로 유포했다. 운영자가 메일을 확인한 순간 ID를 얻을 수 있었고, 해커는 이 ID를 이용하여 옥션 서버에 로그인할 수 있었다고 한다.
</p>

<h2 id="장고에서-csrf-적용하기">장고에서 CSRF 적용하기</h2>
<p>장고에서는 1.2 버전부터 CSRF 취약점을 막는 기능을 기본으로 제공한다. 모든 POST 방식의 폼 전송에 hidden 필드로 세션에 따른 임의 키 값을 전송하며 해당 키 값이 유효한지 매번 확인한다.</p>

<p><strong>1.</strong> 설정 파일(settings.py) <code class="highlighter-rouge">미들웨어</code>에 <code class="highlighter-rouge">django.middleware.csrf.CsrfViewMiddleware</code>를 추가한다. 장고 1.2 이상 버전의 경우 기본으로 포함되어 있다. <br />
<strong>2.</strong> POST가 사용된 장고 템플릿에 <code class="highlighter-rouge"><span class="p">{</span><span class="err">%</span><span class="w"> </span><span class="err">csrf_token</span><span class="w"> </span><span class="err">%</span><span class="p">}</span></code>을 삽입한다. <a href="https://bbungsang.github.io/%EB%91%90%EC%88%9F%EA%B0%88%20%EC%8A%A4%ED%84%B0%EB%94%94/two-scoops/2017/08/30/ch15-dtl-jinja2.html">Jinja2</a>의 경우 <code class="highlighter-rouge"><span class="p">{</span><span class="err">{</span><span class="w"> </span><span class="err">csrf_input</span><span class="w"> </span><span class="p">}</span><span class="err">}</span></code>을 삽입한다.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code>
<span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s">""</span> <span class="n">method</span><span class="o">=</span><span class="s">"POST"</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">csrf_token</span> <span class="o">%</span><span class="p">}</span>
    <span class="c"># Jinja2, {{ csrf_input }}</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
    <span class="o">&lt;</span><span class="n">button</span> <span class="nb">type</span><span class="o">=</span><span class="s">"submit"</span><span class="o">&gt;</span><span class="err">제출</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>

</code></pre>
</div>

    </section>
    <br><br>
    <footer>

      <!-- option to limit page -->
      
      

      

      <ul class="other-posts">
        
        <li class="prev-or-next">
          <a href="/it/%EA%B8%B0%EB%B3%B8%EA%B0%9C%EB%85%90/basic-concept/2017/10/28/csrf-cors.html">
            <span class="glyphicon glyphicon-chevron-left"></span>
            CORS와 CSRF(1)
          </a>
        </li>
        
        
      </ul>
      <!-- <section class="my-intro">
        <img src="/images/itsme.png">
        <article>
          <p>뿡상</p>
          궁금하시거나 틀린 부분이 있다면 언제든 문의주세요:D
        </article>
      </section> -->
      
  <div id="disqus_thread"></div>
  <script>

  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://https-bbungsang-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    </footer>
  </article>
</section>

  </div>
</body>
</html>
